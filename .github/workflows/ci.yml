name: CI

on: [push, pull_request]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true
          virtualenvs-path: .venv
      - name: Install Python requirements
        run: poetry install
      - name: Lint Python
        run: |
          poetry run isort . --diff --verbose
          poetry run black . --check --verbose
          poetry run flake8 . --verbose

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      - uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true
          virtualenvs-path: .venv
      - name: Get fixtures
        run: cd .. && git clone https://github.com/nationalarchives/tna-frontend.git
      - name: Install Python requirements
        run: poetry install
      - name: Install Node dependencies
        run: cd tasks && npm install
      - name: Run server
        run: poetry run flask --app tna-frontend-jinja run --debug --port 5000 &
      - name: Run the tests
        run: node ./tasks/test.mjs || exit 1
